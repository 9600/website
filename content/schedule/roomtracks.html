---
title: Room occupation by track
sponsors_under_navigation: true
---
<%
# vim: set ft=eruby ts=2 sw=2 et ai:

colors = 5
compress = true

days.each do |d|

  interval = $timetable.fetch(d[:slug]).fetch(:interval)

  flatlist_by_room = begin
                       h = {}
                       $timetable.fetch(d[:slug]).fetch(:by_room).each do |room, time_cells|
                         h[room] = begin
                                     clusters = []
                                     cells = time_cells.values.map(&:first)
                                     cells.each do |cell|
                                       if cell.nil?
                                         clusters << nil
                                       elsif cell[:state] == :begin
                                         clusters << cell
                                       end
                                     end

                                     if compress
                                       cc = []
                                       i = 0
                                       while i < clusters.size
                                         cell = clusters[i]
                                         if cell.nil?
                                           cc << nil
                                           i += 1
                                         else
                                           j = i + 1
                                           xs = 0
                                           xn = 0
                                           xm = 0
                                           while j < clusters.size and xn < (60 / interval)
                                             fcell = clusters[j]
                                             if fcell.nil?
                                               xn += 1
                                             elsif fcell[:track] == cell[:track]
                                               xm += 1
                                               xs += fcell[:slots]
                                               xs += xn
                                               xn = 0
                                             else
                                               break
                                             end
                                             j += 1
                                           end
                                           if xm > 0
                                             cc << { track: cell[:track], slots: cell[:slots] + xs}
                                             (0..xn-1).each do |n|
                                               cc << nil
                                             end
                                             i = j
                                           else
                                             cc << cell
                                             i += 1
                                           end
                                         end
                                       end
                                       cc
                                     else
                                       clusters
                                     end
                                   end
                       end
                       h
                     end

%>
<a name="<%= d[:slug] %>"></a><h2><%= d[:title] %></h2>
<table class="table table-striped table-bordered table-condensed roomtracks">
  <%
    start = Time.parse(d[:start_time])
    start_hour = start.hour
    start_offset_slots = start.min / interval
    num_cells = Time.parse(d[:end_time]).hour - start_hour
    num_slots = num_cells * (60 / interval)
    c = -1
    last_track = nil
  %>
  <thead>
    <tr>
      <th class="building"></th>
      <th class="room">Room</th>
      <%
        (0..num_cells-1).each do |i|
      %>
      <th colspan="<%= 60 / interval %>" style="text-align: left;"><%= format("%02d", start_hour + i) %></th>
      <%
        end
      %>
    </tr>
  </thead>
  <tbody>
    <%
      $buildings.each do |building, brooms|
        brooms.each_with_index do |room, bri|
          cells = flatlist_by_room.fetch(room[:slug])
    %>
      <tr<% if bri == 0 %> class="building_start"<% end %>>
        <%
          if bri == 0
        %>
        <th rowspan="<%= brooms.size %>" class="building"><%= room[:building] %></th>
        <% end %>
        <th class="room"><%= l(room) %></th>
        <% (0..start_offset_slots-1).each do |x| %>
          <td></td>
        <% end %>
        <%
          slots = 0
          cells.each do |cell|
            if cell.nil?
              slots += 1
          %>
          <td></td>
          <%
            else
              slots += cell[:slots]
              cv = if last_track.nil? or cell[:track] != last_track
                     c += 1
                     c %= colors
                     last_track = cell[:track]
                     c + 1
                   else
                     c + 1
                   end
            %>
            <td class="c<%= cv %>" colspan="<%= cell[:slots] %>"><%= l(track(cell[:track]), :name, '', :title) %></td>
          <% end %>
          <%
          end

          (0..num_slots-start_offset_slots-slots - 1).each do |x|
          %>
          <td></td>
          <%
          end
        end
        %>
      </tr>
    <% end %>
  </tbody>
</table>
<% end %>

